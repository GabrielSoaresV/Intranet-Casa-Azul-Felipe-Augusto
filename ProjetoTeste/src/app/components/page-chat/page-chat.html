<app-navbar></app-navbar>

<div class="chat-preview-container" *ngIf="!isLoading; else loading">
  <!-- ğŸ”¹ CabeÃ§alho -->
  <div class="header-card">
    <h2>Chat da Demanda</h2>
    <span class="status-badge in_progress">Em andamento</span>
  </div>

  <!-- ğŸ”¹ Caixa de chat -->
  <div class="chat-card">
    <div class="chat-box">
      <div *ngFor="let msg of messages" class="chat-message-wrapper">
        <ng-container *ngIf="msg.user as user">
          <div
            class="chat-message"
            [ngClass]="user.cpf === currentUserCpf ? 'mine' : 'theirs'"
          >
            <!-- Avatar -->
            <img
              class="msg-avatar"
              [src]="getAvatarUrlCached(user)"
              [alt]="user.name || 'UsuÃ¡rio'"
              [title]="user.name || 'UsuÃ¡rio'"
            />

            <!-- BalÃ£o -->
            <div class="msg-bubble" [ngClass]="getBubbleClass(user.cpf)">
              <div class="msg-header">
                <span class="msg-sender">{{ user.name || 'UsuÃ¡rio' }}</span>
                <span class="msg-time">{{ msg.createdAt | date: 'shortTime' }}</span>
              </div>
              <div class="msg-content">
                {{ msg.message }}
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>

    <!-- ğŸ”¹ Campo de envio -->
    <form [formGroup]="chatForm" (ngSubmit)="sendMessage()" class="chat-input">
      <input
        type="text"
        formControlName="message"
        placeholder="Digite uma mensagem..."
        autocomplete="off"
      />
      <button type="submit" [disabled]="chatForm.invalid">
        <mat-icon>send</mat-icon>
      </button>
    </form>
  </div>
</div>

<ng-template #loading>
  <div class="loading">Carregando mensagens...</div>
</ng-template>
